# Makefile.in

.PRECIOUS: Makefile
.SUFFIXES: .c .o .a

srcdir = @srcdir@
top_srcdir = @top_srcdir@
prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
mandir = @mandir@
man1dir = @man1dir@

CC = @CC@
CFLAGS = @CFLAGS@
CPP = @CPP@
CPPFLAGS = @CPPFLAGS@
LD = @LD@
LDFLAGS = @LDFLAGS@
MKDIR_P = @MKDIR_P@
CP_FP = @CP_FP@
RM_F = @RM_F@

@USE_SYSTEM_LIBPNG_FALSE@LIB_LIBPNG =
@USE_SYSTEM_LIBPNG_TRUE@LIB_LIBPNG = @LIBPNG@
@USE_SYSTEM_ZLIB_FALSE@LIB_ZLIB =
@USE_SYSTEM_ZLIB_TRUE@LIB_ZLIB = @LIBZ@
LIBM = @LIBM@
LIBS = @LIBS@
ALL_LIBS = $(LIB_LIBPNG) $(LIB_ZLIB) $(LIBM) $(LIBS)

OPTIPNG_DIR = $(top_srcdir)/src/optipng
CEXCEPT_DIR = $(top_srcdir)/third_party/cexcept
WILDARGS_DIR = $(top_srcdir)/third_party/wildargs
OPNGREDUC_DIR = $(top_srcdir)/src/opngreduc
OPNGREDUC_LIB = libopngreduc.a
OPNGREDUC_MK = @OPNGREDUC_MK@
PNGXTERN_DIR = $(top_srcdir)/src/pngxtern
PNGXTERN_LIB = libpngxtern.a
PNGXTERN_MK = @PNGXTERN_MK@
@USE_SYSTEM_LIBPNG_FALSE@LIBPNG_DIR = $(top_srcdir)/third_party/libpng
@USE_SYSTEM_LIBPNG_FALSE@LIBPNG_LIB = libpng.a
@USE_SYSTEM_LIBPNG_TRUE@LIBPNG_LIB = -lpng
@USE_SYSTEM_LIBPNG_FALSE@LIBPNG_MK = @LIBPNG_MK@
@USE_SYSTEM_LIBPNG_FALSE@LIBPNG_MK_DEF = @LIBPNG_MK_DEF@
@USE_SYSTEM_ZLIB_FALSE@ZLIB_DIR = $(top_srcdir)/third_party/zlib
@USE_SYSTEM_ZLIB_FALSE@ZLIB_LIB = libz.a
@USE_SYSTEM_ZLIB_TRUE@ZLIB_LIB = -lz
@USE_SYSTEM_ZLIB_FALSE@ZLIB_MK = @ZLIB_MK@
GIFREAD_DIR = $(top_srcdir)/third_party/gifread
GIFREAD_LIB = libgifread.a
GIFREAD_MK = @GIFREAD_MK@
MINITIFF_DIR = $(top_srcdir)/third_party/minitiff
MINITIFF_LIB = libminitiff.a
MINITIFF_MK = @MINITIFF_MK@
PNMIO_DIR = $(top_srcdir)/third_party/pnmio
PNMIO_LIB = libpnmio.a
PNMIO_MK = @PNMIO_MK@

OPTIPNG_OBJS = \
  optipng.o \
  optim.o \
  bitset.o \
  ioutil.o \
  ratio.o \
  wildargs.o

@USE_SYSTEM_ZLIB_FALSE@OPTIPNG_DEPLIB_ZLIB = $(ZLIB_DIR)/$(ZLIB_LIB)
@USE_SYSTEM_ZLIB_TRUE@OPTIPNG_DEPLIB_ZLIB =
@USE_SYSTEM_LIBPNG_FALSE@OPTIPNG_DEPLIB_LIBPNG = $(LIBPNG_DIR)/$(LIBPNG_LIB)
@USE_SYSTEM_LIBPNG_TRUE@OPTIPNG_DEPLIB_ZLIB =

OPTIPNG_DEPLIBS = \
  $(OPNGREDUC_DIR)/$(OPNGREDUC_LIB) \
  $(PNGXTERN_DIR)/$(PNGXTERN_LIB) \
  $(OPTIPNG_DEPLIB_LIBPNG) \
  $(OPTIPNG_DEPLIB_ZLIB) \
  $(GIFREAD_DIR)/$(GIFREAD_LIB) \
  $(MINITIFF_DIR)/$(MINITIFF_LIB) \
  $(PNMIO_DIR)/$(PNMIO_LIB)

@USE_SYSTEM_ZLIB_FALSE@OPTIPNG_DEPINCLUDE_ZLIB = -I$(ZLIB_DIR)
@USE_SYSTEM_ZLIB_TRUE@OPTIPNG_DEPINCLUDE_ZLIB =
@USE_SYSTEM_LIBPNG_FALSE@OPTIPNG_DEPINCLUDE_LIBPNG = -I$(LIBPNG_DIR)
@USE_SYSTEM_LIBPNG_TRUE@OPTIPNG_DEPINCLUDE_LIBPNG =
OPTIPNG_DEPINCLUDES = \
  -I$(CEXCEPT_DIR) \
  $(OPTIPNG_DEPINCLUDE_ZLIB) \
  $(OPTIPNG_DEPINCLUDE_LIBPNG) \
  -I$(OPNGREDUC_DIR) \
  -I$(PNGXTERN_DIR)

OPTIPNG_TESTS = \
  bitset_test$(EXEEXT) \
  ratio_test$(EXEEXT)
OPTIPNG_TESTOBJS = \
  bitset_test.o \
  ratio_test.o
OPTIPNG_TESTOUT = *.out *.out*.bak *.out.png

.PHONY: all
all: optipng$(EXEEXT)

optipng$(EXEEXT): $(OPTIPNG_OBJS) $(OPTIPNG_DEPLIBS)
	$(LD) $(LDFLAGS) -o $@ $(OPTIPNG_OBJS) $(OPTIPNG_DEPLIBS) $(ALL_LIBS)

.c.o:
	$(CC) -c $(CPPFLAGS) $(CFLAGS) $(OPTIPNG_DEPINCLUDES) -o $@ $<

optipng.o: optipng.c optipng.h bitset.h proginfo.h $(OPTIPNG_DEPLIBS)
optim.o: optim.c optipng.h bitset.h ioutil.h ratio.h $(OPTIPNG_DEPLIBS)
bitset.o: bitset.c bitset.h
ioutil.o: ioutil.c ioutil.h
ratio.o: ratio.c ratio.h

wildargs.o: $(WILDARGS_DIR)/wildargs.c
	$(CC) -c $(CPPFLAGS) $(CFLAGS) -o $@ $<

$(OPNGREDUC_DIR)/$(OPNGREDUC_LIB): \
  $(OPTIPNG_DEPLIB_LIBPNG)
	cd $(OPNGREDUC_DIR) && \
	$(MAKE) -f $(OPNGREDUC_MK) $(OPNGREDUC_LIB) && \
	cd $(OPTIPNG_DIR)

$(PNGXTERN_DIR)/$(PNGXTERN_LIB): \
  $(OPTIPNG_DEPLIB_LIBPNG) \
  $(GIFREAD_DIR)/$(GIFREAD_LIB) \
  $(MINITIFF_DIR)/$(MINITIFF_LIB) \
  $(PNMIO_DIR)/$(PNMIO_LIB)
	cd $(PNGXTERN_DIR) && \
	$(MAKE) -f $(PNGXTERN_MK) $(PNGXTERN_LIB) && \
	cd $(OPTIPNG_DIR)

$(LIBPNG_DIR)/$(LIBPNG_LIB): \
  $(OPTIPNG_DEPLIB_ZLIB)
	cd $(LIBPNG_DIR) && \
	$(MAKE) -f $(LIBPNG_MK) $(LIBPNG_MK_DEF) && \
	cd $(OPTIPNG_DIR)

$(ZLIB_DIR)/$(ZLIB_LIB):
	cd $(ZLIB_DIR) && \
	$(MAKE) -f $(ZLIB_MK) && \
	cd $(OPTIPNG_DIR)

$(GIFREAD_DIR)/$(GIFREAD_LIB):
	cd $(GIFREAD_DIR) && \
	$(MAKE) -f $(GIFREAD_MK) $(GIFREAD_LIB) \
	        CC="$(CC)" CFLAGS="$(CFLAGS)" \
	        CPP="$(CPP)" CPPFLAGS="$(CPPFLAGS)" \
	        LD="$(LD)" LDFLAGS="$(LDFLAGS)" && \
	cd $(OPTIPNG_DIR)

$(MINITIFF_DIR)/$(MINITIFF_LIB):
	cd $(MINITIFF_DIR) && \
	$(MAKE) -f $(MINITIFF_MK) $(MINITIFF_LIB) \
	        CC="$(CC)" CFLAGS="$(CFLAGS)" \
	        CPP="$(CPP)" CPPFLAGS="$(CPPFLAGS)" \
	        LD="$(LD)" LDFLAGS="$(LDFLAGS)" && \
	cd $(OPTIPNG_DIR)

$(PNMIO_DIR)/$(PNMIO_LIB):
	cd $(PNMIO_DIR) && \
	$(MAKE) -f $(PNMIO_MK) $(PNMIO_LIB) \
	        CC="$(CC)" CFLAGS="$(CFLAGS)" \
	        CPP="$(CPP)" CPPFLAGS="$(CPPFLAGS)" \
	        LD="$(LD)" LDFLAGS="$(LDFLAGS)" && \
	cd $(OPTIPNG_DIR)

.PHONY: test
test: local-test test-gifread test-minitiff

.PHONY: local-test
local-test: optipng$(EXEEXT) $(OPTIPNG_TESTS)
	./optipng$(EXEEXT) -o1 -q --clobber testimg/pngtest.png --out=pngtest.out.png
	./optipng$(EXEEXT) -o1 -q --clobber pngtest.out.png --out=pngtest.out.out.png
	cmp pngtest.out.png pngtest.out.out.png
	-@echo optipng smoke test ... ok
	./bitset_test$(EXEEXT) > bitset_test.out
	-@echo bitset test ... ok
	./ratio_test$(EXEEXT) > ratio_test.out
	-@echo ratio test ... ok

bitset_test$(EXEEXT): bitset_test.o bitset.o
	$(LD) $(LDFLAGS) -o $@ \
	  bitset_test.o bitset.o $(LIBS)

ratio_test$(EXEEXT): ratio_test.o ratio.o
	$(LD) $(LDFLAGS) -o $@ \
	  ratio_test.o ratio.o $(LIBS)

bitset_test.o: testprog/bitset_test.c bitset.h
	$(CC) -c -I. $(CPPFLAGS) $(CFLAGS) -o $@ $<

ratio_test.o: testprog/ratio_test.c ratio.h
	$(CC) -c -I. $(CPPFLAGS) $(CFLAGS) -o $@ $<

.PHONY: test-gifread
test-gifread:
	cd $(GIFREAD_DIR) && \
	$(MAKE) -f $(GIFREAD_MK) test && \
	cd $(OPTIPNG_DIR)

.PHONY: test-minitiff
test-minitiff:
	cd $(MINITIFF_DIR) && \
	$(MAKE) -f $(MINITIFF_MK) test && \
	cd $(OPTIPNG_DIR)

.PHONY: check
check: test

.PHONY: clean
clean: \
  local-clean \
  clean-opngreduc \
  clean-pngxtern \
  clean-gifread \
  clean-minitiff \
  clean-pnmio \
  clean-libpng \
  clean-zlib

.PHONY: local-clean
local-clean:
	-$(RM_F) optipng$(EXEEXT) $(OPTIPNG_OBJS)
	-$(RM_F) $(OPTIPNG_TESTS) $(OPTIPNG_TESTOBJS) $(OPTIPNG_TESTOUT)

.PHONY: clean-opngreduc
clean-opngreduc:
	cd $(OPNGREDUC_DIR) && \
	$(MAKE) -f $(OPNGREDUC_MK) clean && \
	cd $(OPTIPNG_DIR)

.PHONY: clean-pngxtern
clean-pngxtern:
	cd $(PNGXTERN_DIR) && \
	$(MAKE) -f $(PNGXTERN_MK) clean && \
	cd $(OPTIPNG_DIR)

.PHONY: clean-gifread
clean-gifread:
	cd $(GIFREAD_DIR) && \
	$(MAKE) -f $(GIFREAD_MK) clean && \
	cd $(OPTIPNG_DIR)

.PHONY: clean-minitiff
clean-minitiff:
	cd $(MINITIFF_DIR) && \
	$(MAKE) -f $(MINITIFF_MK) clean && \
	cd $(OPTIPNG_DIR)

.PHONY: clean-pnmio
clean-pnmio:
	cd $(PNMIO_DIR) && \
	$(MAKE) -f $(PNMIO_MK) clean && \
	cd $(OPTIPNG_DIR)

.PHONY: clean-libpng
clean-libpng:
@USE_SYSTEM_LIBPNG_FALSE@	cd $(LIBPNG_DIR) && \
@USE_SYSTEM_LIBPNG_FALSE@	$(MAKE) -f $(LIBPNG_MK) $(LIBPNG_MK_DEF) clean && \
@USE_SYSTEM_LIBPNG_FALSE@	cd $(OPTIPNG_DIR)

.PHONY: clean-zlib
clean-zlib:
@USE_SYSTEM_ZLIB_FALSE@	cd $(ZLIB_DIR) && \
@USE_SYSTEM_ZLIB_FALSE@	$(MAKE) -f $(ZLIB_MK) clean && \
@USE_SYSTEM_ZLIB_FALSE@	cd $(OPTIPNG_DIR)

.PHONY: distclean
distclean: \
  local-distclean \
  distclean-opngreduc \
  distclean-pngxtern \
  distclean-gifread \
  distclean-minitiff \
  distclean-pnmio \
  distclean-libpng \
  distclean-zlib

.PHONY: local-distclean
local-distclean: local-clean
	-$(RM_F) Makefile
	cd man && \
	$(MAKE) distclean && \
	cd ..

.PHONY: distclean-opngreduc
distclean-opngreduc:
	cd $(OPNGREDUC_DIR) && \
	$(MAKE) -f $(OPNGREDUC_MK) distclean && \
	cd $(OPTIPNG_DIR)

.PHONY: distclean-pngxtern
distclean-pngxtern:
	cd $(PNGXTERN_DIR) && \
	$(MAKE) -f $(PNGXTERN_MK) distclean && \
	cd $(OPTIPNG_DIR)

.PHONY: distclean-gifread
distclean-gifread:
	cd $(GIFREAD_DIR) && \
	$(MAKE) -f $(GIFREAD_MK) distclean && \
	cd $(OPTIPNG_DIR)

.PHONY: distclean-minitiff
distclean-minitiff:
	cd $(MINITIFF_DIR) && \
	$(MAKE) -f $(MINITIFF_MK) distclean && \
	cd $(OPTIPNG_DIR)

.PHONY: distclean-pnmio
distclean-pnmio:
	cd $(PNMIO_DIR) && \
	$(MAKE) -f $(PNMIO_MK) distclean && \
	cd $(OPTIPNG_DIR)

.PHONY: distclean-libpng
distclean-libpng:
@USE_SYSTEM_LIBPNG_FALSE@	cd $(LIBPNG_DIR) && \
@USE_SYSTEM_LIBPNG_FALSE@	$(MAKE) -f $(LIBPNG_MK) $(LIBPNG_MK_DEF) @LIBPNG_DISTCLEAN@ && \
@USE_SYSTEM_LIBPNG_FALSE@	@LIBPNG_DISTCLEAN_XCMD@ && \
@USE_SYSTEM_LIBPNG_FALSE@	cd $(OPTIPNG_DIR)

.PHONY: distclean-zlib
distclean-zlib:
@USE_SYSTEM_ZLIB_FALSE@	cd $(ZLIB_DIR) && \
@USE_SYSTEM_ZLIB_FALSE@	$(MAKE) -f $(ZLIB_MK) @ZLIB_DISTCLEAN@ && \
@USE_SYSTEM_ZLIB_FALSE@	cd $(OPTIPNG_DIR)

.PHONY: install
install: optipng$(EXEEXT)
	$(MKDIR_P) $(DESTDIR)$(bindir)
	$(MKDIR_P) $(DESTDIR)$(man1dir)
	-@$(RM_F) $(DESTDIR)$(bindir)/optipng$(EXEEXT)
	-@$(RM_F) $(DESTDIR)$(man1dir)/optipng.1
	$(CP_FP) optipng$(EXEEXT) $(DESTDIR)$(bindir)
	$(CP_FP) man/optipng.1 $(DESTDIR)$(man1dir)

.PHONY: uninstall
uninstall:
	-$(RM_F) $(DESTDIR)$(bindir)/optipng$(EXEEXT)
	-$(RM_F) $(DESTDIR)$(man1dir)/optipng.1
